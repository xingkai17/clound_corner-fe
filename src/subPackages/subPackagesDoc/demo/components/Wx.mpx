<!-- 微信小程序功能 -->
<template>
  <view class="demo">

    <view>当前页面功能只在微信小程序中生效，本地调试请使用打包小程序的命令（如 <code>npm run serve:wx-ie/te/se</code>），在微信开发者工具中查看。</view>

    <h3>截图</h3>
    <p>请进行屏幕截图或调用系统截图后，观察下面文字是否改变：</p>
    <view>{{userCaptureScreened ? '已触发截屏事件' : '截屏事件未触发'}}</view>

    <h3>
      登录
      <span class="copy" bindtap="copy" data-value="hhtps://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">开放接口/登录/wx.login</span>
    </h3>
    <button size="mini" bindtap="login">点我调用</button>

    <h3>
      获取头像、昵称
      <span class="copy" bindtap="copy" data-value="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html">开放接口/用户信息/wx.getUserProfile</span>
    </h3>
    <button wx:if="{{false}}" size="mini" bindtap="getUserProfile">获取头像昵称 getUserProfile</button>
    <button wx:else size="mini" open-type="getUserInfo" bindgetuserinfo="getUserInfo">获取头像昵称 getUserInfo</button>
    <button size="mini" open-type="chooseAvatar" bindchooseavatar="chooseAvatar">获取头像 chooseAvatar</button>
    <!-- 微信开发者工具上不会立马同步到 userInfo.nickName 中，但是真机上可以；@blur="getNickName"-->
    <input
      type="nickname"
      value="{{userInfo.nickName}}"
      placeholder="获取昵称 getNickName"
      placeholder-style="color: #2CA245;"
      bindnicknamereview="getNickName"
    />
    <view>
      <view class="item">
        <view class="item-label">昵称：</view>
        <view class="item-value">{{userInfo.nickName || '-'}}</view>
      </view>
      <view class="item">
        <view class="item-label">头像：</view>
        <view class="item-value">
          <image wx:if="{{userInfo.avatarUrl}}" src="{{userInfo.avatarUrl || ''}}" alt="" class="img"/>
          <text wx:else>-</text>
        </view>
      </view>
    </view>

    <h3>
      获取手机号
      <span class="copy" bindtap="copy" data-value="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">开放能力/用户信息/手机号快速验证组件</span>
    </h3>
    <button size="mini" bindtap="getMobile">点我调用</button>

    <h3>
      生成小程序链接
      <span class="copy" bindtap="copy" data-value="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/url-scheme.html">开放能力/获取小程序链接/获取 URL Scheme</span>
    </h3>
    <button size="mini" bindtap="createWxLink">点我调用</button>

    <!-- <web-view src="http://192.168.88.21:8003?timestamp=1690973400768&kunlun_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJpZD03ODE1NiBlbXBsb3llZUlkPTIxNTY4MyB0ZW5hbnRJZD0xMTY1IGNsaWVudEtleT0xMDAwMTE0IGNyZWF0ZUF0PTIwMjMtMDctMjYgMTU6NDg6NDgiLCJsb2NhdGlvbiI6dHJ1ZSwiZW1wbG95ZWVJZCI6MjE1NjgzLCJpZCI6NzgxNTYsImV4cCI6MTY5MDk2MjUyOH0.wySZB4U2FZbactiuvDZUQji7wAiAS3S17RKgCmDmv9M&origin=xxx" bindmessage="getMessage"/> -->

    <!-- web-view 组件加载网络 html 示例 -->
    <!-- <web-view src="https://uniapp.dcloud.io/static/web-view.html" bindmessage="getMessage"/> -->

  </view>
</template>

<script>
import mpx, { createComponent } from '@mpxjs/core';

createComponent({
  data: {
    userCaptureScreened: false, // 用户是否截屏：https://developers.weixin.qq.com/miniprogram/dev/api/device/screen/wx.onUserCaptureScreen.html
    canIUseGetUserProfile: !!mpx.getUserProfile,
    userInfo: {
      nickName: null,
      avatarUrl: null,
    },
  },

  onLoad() {
    mpx.onUserCaptureScreen(() => {
      console.log('用户截屏了');
      this.userCaptureScreened = true;
    });
  },

  methods: {
    // 复制文本
    copy(e) {
      const value = e.currentTarget.dataset.value;
      mpx.setClipboardData({ data: value });
    },

    // 登录
    login() {
      console.log('登录');
      mpx.login({
        success(res) {
          // code 用户登录凭证（有效期五分钟）。开发者需要在开发者服务器后台调用 code2Session，使用 code 换取 openid、unionid、session_key 等信息
          if (res.code) {
            console.log('res', res);
            console.log('res.code', res.code);
            // // 发起网络请求
            // mpx.request({
            //   url: 'https://example.com/onLogin',
            //   data: {
            //     code: res.code,
            //   },
            // });
          } else {
            console.log('登录失败！' + res.errMsg);
          }
        },
      });
    },

    // 获取头像、昵称
    getUserProfile() {
      console.log('获取头像');
      // 推荐使用mpx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认
      // 开发者妥善保管用户快速填写的头像昵称，避免重复弹窗
      mpx.getUserProfile({
        desc: '用于完善会员资料', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
        success: (res) => {
          console.log('res', res);
          if (res?.userInfo) {
            Object.assign(this.userInfo, {
              nickName: res.userInfo.nickName,
              avatarUrl: res.userInfo.avatarUrl,
            });
          }
        },
      });
    },

    getUserInfo(e) {
      // 不推荐使用getUserInfo获取用户信息，预计自2021年4月13日起，getUserInfo将不再弹出弹窗，并直接返回匿名的用户个人信息
      if (e.detail?.userInfo) {
        console.log('e.detail?.userInfo', e.detail?.userInfo);
        Object.assign(this.userInfo, {
          nickName: e.detail.userInfo.nickName,
          avatarUrl: e.detail.userInfo.avatarUrl,
        });
      }
    },

    chooseAvatar(e) {
      console.log(e);
      const value = e.detail.avatarUrl;
      console.log('chooseAvatar', value);
      this.userInfo.avatarUrl = value;
    },

    getNickName(e) {
      console.log(e);
      const value = e.detail.value;
      console.log('getNickName', value);
      this.userInfo.nickName = value;
    },

    // 获取手机号
    getMobile() {
      console.log('获取手机号');

      mpx.showModal({
        title: '温馨提示',
        content: '亲，授权微信登录后才能正常使用小程序功能',
        success(res) {
          console.log(0);
          console.log(res); // 如果用户点击了确定按钮
          if (res.confirm) {
            mpx.getUserProfile({
              desc: '获取你的昵称、头像、地区及性别',
              success: res => {
                console.log(res);
                console.log(1);
              },
              fail: res => {
                console.log(2);
                console.log(res);
                // 拒绝授权
                mpx.showToast({
                  title: '您拒绝了请求不能正常使用小程序',
                  icon: 'error',
                  duration: 2000,
                });
                return;
              },
            });
          } else if (res.cancel) {
            // 如果用户点击了取消按钮
            console.log(3);
            mpx.showToast({
              title: '您拒绝了请求不能正常使用小程序',
              icon: 'error',
              duration: 2000,
            });
            return;
          }
        },
      });
    },

    // 生成小程序链接
    createWxLink() {
      console.log('生成小程序链接');
    },

    getMessage(event) {
      console.log('event', event);
      mpx.showToast({ title: 'getMessage' });

      // mpx.showModal({
      //   content: JSON.stringify(event.detail),
      //   showCancel: false
      // });
    },
  },
});
</script>

<style lang="less" scoped>
.copy {
  margin-left: 6px;
  font-size: 12px;
  color: #0077FF;
}

.uni-padding-wrap {
  padding: 15px;
  background-color: #FFFFFF;
}

.item {
  display: flex;

  &-label {
    width: auto;
    min-width: 50px;
    flex-shrink: 0;
    flex-grow: 0;
  }

  &-value {
    .img {
      width: 50px;
      height: 50px;
    }
  }
}
</style>
